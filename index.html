<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="pragma" content="no-cache"> <!-- キャッシュさせない設定 -->
    <meta name="expires" content="0"> <!-- キャッシュさせない設定 -->
    <meta http-equiv="cache-control" content="no-cache, no-store"> <!-- キャッシュさせない設定 -->
    <meta name="robots" content="noindex"> <!-- インデックスさせない設定 -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>かんたん勤怠｜NAV ver20240605</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
    <base target="_top">
</head>
<body onLoad="setTimeout('closewindow()', 300000)">

    <form class="mx-auto">
        <div class="" style="display: flex; flex-direction: column; padding: 20px;">
            <!-- <div style="display: flex;">
                <button type="button" id="clock-in-button" style="color: white; background-color: rgb(255, 100, 100); font-weight:900; font-size: 24px; width: 60%; height: 200px; margin:5px 2.5px 15px 0px; border:none; border-radius: 10px; box-shadow: 0px 10px rgb(200, 0, 0);">通常出勤</button>
                <button type="button" id="ouen-clock-in-button" style="color: white; background-color: rgb(255, 120, 0); font-weight:900; font-size: 24px; width: 40%; height: 200px; margin:5px 0px 15px 2.5px; border:none; border-radius: 10px; box-shadow: 0px 10px rgb(180, 50, 0);">応援出勤</button>
            </div> -->
            <p style="color:rgb(0, 0, 0); font-size:24px; margin:10px auto; text-align: left; width:100%;">
                <input name="clock" type="radio" value="出勤" style="transform:scale(2.5); margin:20px;" checked>出勤
                <input name="clock" type="radio" value="退勤" style="transform:scale(2.5); margin:20px;" >退勤
            </p>
            <p style="color:rgb(0, 0, 0); font-size: 24px; margin:5px auto; text-align: left; width:100%;">区分</p>
                <select id="location" name="location" style="width:100%; height:60px; padding:5px; font-size:24px;" required>
                    <option value="事務所">事務所</option>
                    <option value="現場">現場</option>
                    <option value="現調">現調</option>
                    <option value="打合せ">打合せ</option>
                    <option value="移動">移動</option>
                    <option value="その他">その他</option>
                </select>
            </p>
            <p id="orp-container" style="color:rgb(0, 0, 0); font-size:24px; margin:5px auto; text-align: left; width:100%;">
                <input id="is-orp" type="checkbox" style="transform:scale(2.5); margin:20px;"> ORP案件
            </p>
        
            <div id="contents-container" style="display: flex; font-size:24px; align-items:left; flex-direction:column;">
                <p style="color:rgb(0, 0, 0); font-size:24px; margin:5px auto; text-align: left; width:100%;">目的/作業内容</p>
                <input id="contents" name="contents" style="font-size:24px; width:100%; height:60px; padding:5px; font-size:16px;" required>
            </div>

            <div id="schedule-container" style="display: flex; font-size:24px; align-items:left; flex-direction:column;">
                <p style="color:rgb(0, 0, 0); font-size:24px; margin:5px auto; text-align: left; width:100%;">明日のスケジュール</p>
                <input id="schedule" name="schedule" style="font-size:24px; width:100%; height:60px; padding:5px; font-size:16px;" required>
            </div>

            <button type="button" id="submit-button" style="color: white; background-color: rgb(255, 100, 100); font-weight:900; font-size: 24px; width: 100%; height: 100px; margin-top: 15px; margin-bottom:15px; border:none; border-radius: 10px; box-shadow: 0px 10px rgb(200, 0, 0)">打刻する</button>
        </div>
    </form>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script> <!--サーバーの時刻取得用-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ja.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        //参考URL https://qiita.com/doikatsuyuki/items/7ee2476977e8bb97e2a7

        const liffId = "2004886307-PrgBx30x"; ////LIFF ID(LINEログイン>LIFF>LIFF ID)

        const thisfileURL = location.pathname;

        // $(document).ready(function () {
        //     initializeLiff(liffId);
        // });

        function initializeLiff(liffId) {
            liff.init({
                liffId: liffId
            }).then(() => {
                initializeApp();
            }).catch((error) => {
                console.log('LIFF Initialization failed ', error);
                window.alert('エラーが発生しました。お手数おかけしますが画面を閉じて再実行してください。');
                sendErrorLog('LIFF-InitializationError:' + error.message, thisfileURL, error.lineNumber, error.columnNumber, error);
            });
        };

        function initializeApp() {
        // ログインチェック
            if (liff.isLoggedIn()) {
                //ログイン済
                //getLineData();
            } else {
                // 未ログイン
                let result = window.confirm("LINEにログインしてください");
                if(result) {
                    liff.login();
                }
            }
        }

        const params = (new URL(document.location)).searchParams;
        const key = params.get('key');

        $('#orp-container').show();
        $('#schedule-container').hide();
                
        $('input[name="clock"]').change(function(){
            if ($(this).val() === '出勤') {
                $('#orp-container').show();       
                $('#schedule-container').hide();
            } else {
                $('#orp-container').hide();
                $('#schedule-container').show();
            }
        });

        $(function() {
            $('#submit-button').on('click',function(){
                $('form').submit();
            });
        });

        $('#contents').focus(function(){
            $(this).css('border', '1px solid black');
        });

        $('#schedule').focus(function(){
            $(this).css('border', '1px solid black');
        });

        $(function () {
            $('form').submit(function () {
                const now = new Date(); // 端末時刻を取得
                const nowDateTime = moment(now).format('YYYY/MM/DD(ddd) HH:mm');
                const clockStatus = $('input[name="clock"]:checked').val();
                const locationStatus = $('#location').val();
                const contents = $('#contents').val();
                const schedule = $('#schedule').val();

                let msg = `**打刻完了**\n出勤/退勤:${clockStatus}\n時刻:${nowDateTime}\n区分:${locationStatus}\n目的/作業内容:${contents}`;
                    
                if (inputValidation(contents, schedule, clockStatus)) {
                    msg += clockStatus == '退勤' ? `\n明日のスケジュール:${schedule}` : ''

                    if ($('#is-orp').is(':checked')) {
                        msg += `\nORP案件:○`
                    }
                } else {
                    window.alert("未入力の項目があります")
                    return false
                }

                console.log(msg)
                sendText(msg);
            });
        });

        function inputValidation(contents, schedule, clockStatus) {
            let isError = true

            if (contents == '') {
                $('#contents').css('border', '1px solid #FF6464');
                isError = false
            }
            if (clockStatus == '退勤' && schedule == '') {
                $('#schedule').css('border', '1px solid #FF6464');
                isError = false
            }

            return isError
        }

        // $(function () {
        //     $('form').submit(function () {
        //         //const userID = $('input[name="userID"]').val();
        //         //const displayName = $('input[name="displayName"]').val();
        //         const customCategory = $('input[name="custom-category"]').val();
        //         const category = $('input[name="category"]').val();
        //         const workPlace  = $('input[name="work-place"]').val();
        //         const unitPrice  = $('input[name="unit-price"]').val();

        //         getGeoLocation()
        //         .then((position)=>{
        //             const latitude = position.coords.latitude; //緯度
        //             const longitude = position.coords.longitude; //経度
        //             var url = 'https://geoapi.heartrails.com/api/json?method=searchByGeoLocation&x='+longitude+'&y='+latitude;
        //             return url;
        //         })
        //         .then((url) => fetch(url, {method:'GET'}))
        //         .then((response) => response.json())
        //         .then((json) =>{
        //             const location = json.response.location[0];
        //             const prefecture = location.prefecture;
        //             const city = location.city;
        //             const town = location.town;
        //             const address = prefecture + city + town;
        //             const msg = `**打刻完了**\n区分:${customCategory}\n${address}\n(応援)勤務地:${workPlace}\n(応援)単価:${unitPrice}`;
        //             sendText(msg);
        //         })
        //         .catch((error)=>{ //失敗時
        //             alert(error);
        //             const latitude = 0; //緯度
        //             const longitude = 0; //経度
        //             const address = '-';
        //             const msg = `**打刻完了**\n区分:${customCategory}\n${address}\n(応援)勤務地:${workPlace}\n(応援)単価:${unitPrice}`;
        //             sendText(msg);
        //         });

        //         return false;
        //     });
        // });

        // function getGeoLocation(){
        //     return new Promise((resolve, reject)=>{
        //         navigator.geolocation.getCurrentPosition(
        //             function(position){
        //                 resolve(position);
        //             },
        //             function(error){
        //                 reject(error);
        //             },
        //             {
        //                 "enableHighAccuracy": true ,
        //                 "timeout": 8000 ,
        //                 "maximumAge": 5000 ,
        //             }
        //         );
        //     });
        // }

        // function convertAddress(latitude,longitude){
        //     var url = 'http://geoapi.heartrails.com/api/json?method=searchByGeoLocation&x='+longitude+'&y='+latitude;
        //     fetch(url).then(response => {
        //         return response.json();
        //     })
        //     .then((data)=>{
        //         var location = data.response.location[0];
        //         var prefecture = location.prefecture;
        //         var city = location.city;
        //         var town = location.town;
        //         var address = prefecture + city + town;
        //         return address;
        //     })
        //     .catch((err)=>{
        //         alert(err);
        //     });
        // };

        function sendText(text){
            initializeLiff(liffId);
            liff.ready.then(() => {
                liff.sendMessages([
                    {
                        'type' : 'text',
                        'text' : text,
                    },
                ])
                .then(() =>{
                    liff.closeWindow();
                }).catch((error)=>{
                    console.log(error);
                    window.alert('エラーが発生しました。お手数おかけしますが画面を閉じて再実行してください。');
                    sendErrorLog('SendText Error:'+ error.message, thisfileURL, error.lineNumber, error.columnNumber, error);
                });
            });
        }

        function sendErrorLog(message, source, lineNo, colNo, error){
            // エラー情報をサーバーサイドに送信する

            let errorData = {
                message: message,
                source: source,
                lineno: lineNo,
                colno: colNo,
                error: error? error.stack : null
            };

            console.log(errorData);

            // Fetch APIを使用してサーバーサイドにデータを送信
            fetch('/line_kintai/logging.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(errorData)
            })
            .then(response => {
                if (!response.ok) {
                throw new Error('Failed to log error on the server');
                }
            })
            .catch(error => {
                console.error('Error logging on the server:', error);
            });

            // オリジナルのエラー処理は実行されないようにする
            return true;
        };

        function closewindow(){
            liff.closeWindow();
        }

        window.onerror = (message, source, lineNo, colNo, error) => {
            sendErrorLog('LoadingError:' + message, thisfileURL, lineNo, colNo, error);
        };

    </script>
</body>
</html>